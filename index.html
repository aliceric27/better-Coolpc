<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCBUYBUY</title>
    <!-- 引入 Element Plus -->
    <link
    rel="stylesheet"
    href="//cdn.jsdelivr.net/npm/element-plus/dist/index.css"
  />
  <!-- Import Vue 3 -->
  <script src="//cdn.jsdelivr.net/npm/vue@3"></script>
  <!-- Import component library -->
  <script src="//cdn.jsdelivr.net/npm/element-plus"></script>
    <style>
        .component-select {
            max-width: 60vw;
        }

        .el-select-dropdown__item {
            color: #000 !important;
        }
        
        .bundle-price {
            color: #67C23A !important;
        }
        
        .el-select-dropdown__item.selected {
            color: #000 !important;
        }
        
        .el-select-dropdown__item.selected.bundle-price {
            color: #67C23A !important;
        }

        .el-select-dropdown__item.is-disabled {
            color: #494949 !important;
            background-color: #b6b6b6 !important;
            font-size: 12px !important;
        }

        /* 新增的樣式 */
        .component-row {
            margin-bottom: 15px;
            align-items: center;
        }
        
        .component-title {
            font-weight: bold;
            text-align: right;
            padding-right: 20px;
        }

        /* Loading 動畫樣式 */
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .option-group {
            font-weight: bold;
            background-color: #003c1e !important;
            color: #676767 !important;
        }

        /* 增加選擇器的特異性來提高優先級 */
        .el-select-dropdown__item.option-group {
            font-weight: bold !important;
            background-color: #f5f7fa !important;
            color: #606266 !important;
        }

        /* 確保 is-disabled 不會覆蓋 option-group 的樣式 */
        .el-select-dropdown__item.is-disabled:not(.option-group) {
            color: #595959 !important;
            background-color: #c9c9c9 !important;
        }

        /* 定義四種顏色組合 */
        .color-group-1 {
            background-color: rgba(64, 158, 255, 0.1) !important;
        }
        .color-group-1.option-group {
            background-color: rgba(64, 158, 255, 0.2) !important;
        }

        .color-group-2 {
            background-color: rgba(103, 194, 58, 0.1) !important;
        }
        .color-group-2.option-group {
            background-color: rgba(103, 194, 58, 0.2) !important;
        }

        .color-group-3 {
            background-color: rgba(230, 162, 60, 0.1) !important;
        }
        .color-group-3.option-group {
            background-color: rgba(230, 162, 60, 0.2) !important;
        }

        .color-group-4 {
            background-color: rgba(245, 108, 108, 0.1) !important;
        }
        .color-group-4.option-group {
            background-color: rgba(245, 108, 108, 0.2) !important;
        }

        /* is-disabled 的樣式 */
        .el-select-dropdown__item.is-disabled:not(.option-group) {
            opacity: 0.7 !important;
        }

        /* 在 style 區塊中添加 */
        @media screen and (max-width: 480px) {
            .component-title {
                font-size: 14px;
                padding-right: 5px;
            }
            
            .el-select {
                width: 100%;  /* 確保 select 填滿容器 */
            }

            /* 處理選項文字溢出 */
            .el-select-dropdown__item {
                white-space: normal !important;  /* 允許文字換行 */
                height: auto !important;
                padding: 5px 8px !important;
                line-height: 1.4 !important;
            }
            
            /* 調整下拉選單寬度 */
            .el-select-dropdown {
                width: 90vw !important;  /* 使用視窗寬度的 90% */
                max-width: 360px;
            }
        }

        /* 新增价格显示相关样式 */
        .component-container {
            display: flex;
            align-items: center;
            gap: 10px;  /* 元素之间的间距 */
        }

        .price-display {
            min-width: 100px;
            padding: 8px 12px;
            background-color: #f5f7fa;
            border-radius: 4px;
            color: #67C23A;
            font-weight: bold;
            text-align: right;
        }

        /* 移动端适配 */
        @media screen and (max-width: 480px) {
            .component-container {
                flex-direction: column;
                align-items: stretch;
            }

            .price-display {
                margin-top: 5px;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="loading">
            <div v-if="error" class="alert alert-danger" role="alert">
                無法載入資料，請稍後再試
                <br>
                <small class="text-muted">{{ error }}</small>
            </div>
            <div v-if="loading" class="loading-container">
                <div class="loading-spinner"></div>
            </div>
            <div v-if="componentsData">
                <el-row v-for="component in componentsData" 
                       :key="component.title" 
                       class="component-row">
                    <el-col :xs="4" :sm="6" class="component-title">
                        <span>{{ component.title }}</span>
                    </el-col>
                    <el-col :xs="20" :sm="18">
                        <div class="component-container">
                            <el-select
                                v-model="selectedComponents[component.title]"
                                :placeholder="'請選擇' + component.title"
                                filterable
                                class="component-select"
                                clearable
                                value-key="id">
                                <template #default="{ item }">
                                    <el-option
                                        v-for="item in component.data"
                                        :key="item.id"
                                        :label="item.name"
                                        :value="item"
                                        :disabled="item.price === null || item.isGroup"
                                        :class="{ 
                                            'bundle-price': item.name.includes('搭購價'),
                                            'option-group': item.isGroup,
                                            [`color-group-${item.colorGroup}`]: item.colorGroup > 0
                                        }">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span>{{ item.name }}</span>
                                            <span v-if="item.price" style="color: #67C23A; font-weight: bold;">
                                                ${{ item.price.toLocaleString() }}
                                            </span>
                                        </div>
                                    </el-option>
                                </template>
                            </el-select>
                        </div>
                    </el-col>
                </el-row>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        const app = createApp({
            setup() {
                const API_URL = "https://pcbuybuy.aliceric27.workers.dev/coolpc";
                const componentsData = ref(null);
                const error = ref(null);
                const loading = ref(true);
                const selectedComponents = ref({});

                const processComponentData = (html, selector, componentType) => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const select = doc.querySelector(selector);
                    const data = [];
                    let currentColorGroup = 0;

                    if (!select) {
                        console.error(`找不到 ${componentType} 的選擇器`);
                        return null;
                    }

                    // 處理所有子元素
                    select.childNodes.forEach(node => {
                        if (node.nodeName === 'OPTGROUP') {
                            // 更新顏色組
                            currentColorGroup = (currentColorGroup % 4) + 1;
                            
                            // 添加組標題
                            data.push({
                                id: `group_${node.label}`,
                                name: node.label,
                                price: null,
                                isGroup: true,
                                colorGroup: currentColorGroup
                            });
                            
                            // 處理組內的選項
                            node.querySelectorAll('option').forEach(option => {
                                const value = option.value;
                                if (value === '0' || !value) return;

                                const text = option.textContent;
                                const priceMatch = text.match(/\$([0-9,]+)/);
                                const price = priceMatch ? parseInt(priceMatch[1].replace(',', '')) : null;

                                data.push({
                                    id: value,
                                    name: text.split(',')[0].trim(),
                                    price: price,
                                    isGroup: false,
                                    colorGroup: currentColorGroup
                                });
                            });
                        } else if (node.nodeName === 'OPTION') {
                            const value = node.value;
                            if (value === '0' || !value) return;

                            const text = node.textContent;
                            const priceMatch = text.match(/\$([0-9,]+)/);
                            const price = priceMatch ? parseInt(priceMatch[1].replace(',', '')) : null;

                            data.push({
                                id: value,
                                name: text.split(',')[0].trim(),
                                price: price,
                                isGroup: false,
                                colorGroup: 0  // 非組內選項不設置顏色
                            });
                        }
                    });
                    return { [componentType]: data };
                };

                const fetchData = async () => {
                    try {
                        loading.value = true;
                        error.value = null;
                        
                        const response = await fetch(API_URL);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const html = await response.text();
                        
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        const categories = doc.querySelectorAll('.t');
                        const allData = [];
                        
                        for (let i = 0; i < categories.length; i++) {
                            const componentType = categories[i].textContent.trim();
                            const selector = `#tbdy > tr:nth-child(${i+1}) > td:nth-child(3) > select`;
                            const componentData = processComponentData(html, selector, componentType);
                            if(componentData!==null){
                            allData.push({
                                title: componentType,
                                data: componentData[componentType]
                                });
                            }
                        }

                        componentsData.value = allData;
                    } catch (err) {
                        error.value = err.message;
                        console.error('Error fetching data:', err);
                    } finally {
                        loading.value = false;
                    }
                };

                onMounted(() => {
                    fetchData();
                });

                return {
                    componentsData,
                    error,
                    loading,
                    selectedComponents
                };
            }
        });

        // 使用 Element Plus
        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>
</html>